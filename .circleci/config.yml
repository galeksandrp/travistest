version: 2
jobs:
  build:
    machine: true
    steps:
      - checkout
      - run: echo "export BRANCH=$(echo $CIRCLE_BRANCH | sed 's/^circle-//')" >> $BASH_ENV
      - run: sudo apt-get update && sudo apt-get install -y linux-headers-$(uname -r) virtualbox
      - run: wget https://releases.hashicorp.com/packer/1.2.4/packer_1.2.4_linux_amd64.zip
      - run: unzip packer_1.2.4_linux_amd64.zip -d ~/bin
      - run: chmod +x ~/bin/packer
      - run: wget https://vagrantcloud.com/hashicorp/boxes/precise32/versions/1.0.0/providers/virtualbox.box
      - run: tar xf virtualbox.box
      - run: rm virtualbox.box
      - run: packer build $BRANCH.json
